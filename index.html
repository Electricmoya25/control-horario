<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fichaje de Personal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .digital-clock { font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col">

    <!-- Header Simple -->
    <header class="bg-slate-800 p-4 shadow-md border-b border-slate-700">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="font-bold text-lg text-white"><i class="fa-solid fa-user-clock mr-2"></i>Portal Empleado</h1>
            <div class="text-xs text-slate-400" id="date-display">--/--/----</div>
        </div>
    </header>

    <main class="flex-grow p-4 w-full max-w-md mx-auto space-y-6">

        <!-- Reloj -->
        <div class="text-center py-4">
            <div id="clock" class="text-6xl font-bold text-white digital-clock tracking-tight">00:00:00</div>
        </div>

        <!-- Formulario -->
        <div class="space-y-4 bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tu Nombre / ID</label>
                <input type="text" id="employee-name" placeholder="Ej. Juan Pérez" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 text-white outline-none">
            </div>
            
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nota (Opcional)</label>
                <input type="text" id="log-note" placeholder="Opcional..." class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 text-white outline-none text-sm">
            </div>

            <!-- Botones -->
            <div class="grid grid-cols-2 gap-4 pt-2">
                <button onclick="submitLog('ENTRADA')" id="btn-in" class="bg-emerald-600 hover:bg-emerald-500 text-white p-4 rounded-xl shadow-lg transition flex flex-col items-center gap-1 active:scale-95">
                    <i class="fa-solid fa-right-to-bracket text-2xl mb-1"></i>
                    <span class="font-bold">ENTRADA</span>
                </button>

                <button onclick="submitLog('SALIDA')" id="btn-out" class="bg-rose-600 hover:bg-rose-500 text-white p-4 rounded-xl shadow-lg transition flex flex-col items-center gap-1 active:scale-95">
                    <i class="fa-solid fa-right-from-bracket text-2xl mb-1"></i>
                    <span class="font-bold">SALIDA</span>
                </button>
            </div>
        </div>

        <!-- Historial de HOY -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-3 bg-slate-900/50 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-sm text-slate-300">Fichajes de Hoy</h3>
                <button onclick="fetchTodayLogs()" class="text-xs text-blue-400 hover:text-white"><i class="fa-solid fa-sync"></i></button>
            </div>
            <div id="today-list" class="divide-y divide-slate-700 text-sm">
                <!-- Se llena con JS -->
                <div class="p-4 text-center text-slate-500 text-xs">Cargando...</div>
            </div>
        </div>

    </main>

    <!-- Notificación -->
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-white text-slate-900 px-6 py-3 rounded-full shadow-2xl transition-all duration-300 -translate-y-20 opacity-0 z-50 flex items-center gap-3 font-bold">
        <i class="fa-solid fa-check-circle text-green-600 text-xl"></i>
        <span id="toast-msg">Registrado</span>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN: PEGA TU URL DE SHEETDB AQUÍ
        // ==========================================
        const SHEETDB_URL = 'https://sheetdb.io/api/v1/hwvpn8lhbw0gg'; 
        // Ejemplo: const SHEETDB_URL = 'https://sheetdb.io/api/v1/a1b2c3d4e5f6';
        // ==========================================

        // Reloj
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('es-ES');
            document.getElementById('date-display').textContent = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Cargar nombre previo
        document.addEventListener('DOMContentLoaded', () => {
            const savedName = localStorage.getItem('last_employee_name');
            if(savedName) document.getElementById('employee-name').value = savedName;
            fetchTodayLogs();
        });

        async function submitLog(type) {
            const name = document.getElementById('employee-name').value.trim();
            const note = document.getElementById('log-note').value.trim();
            
            if(!name) return alert("Por favor escribe tu nombre.");
            if(SHEETDB_URL === 'PEGAR_TU_URL_AQUI') return alert("⚠️ Error: No has configurado la URL de la API en el código HTML.");

            localStorage.setItem('last_employee_name', name);
            
            // Bloquear UI
            const btnIn = document.getElementById('btn-in');
            const btnOut = document.getElementById('btn-out');
            btnIn.disabled = true; btnOut.disabled = true;
            btnIn.classList.add('opacity-50'); btnOut.classList.add('opacity-50');

            const now = new Date();
            const data = {
                fecha: now.toLocaleDateString('es-ES'), // DD/MM/AAAA (coincide con Sheet)
                hora: now.toLocaleTimeString('es-ES'),
                empleado: name,
                tipo: type,
                nota: note
            };

            try {
                await fetch(SHEETDB_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [data] })
                });
                
                showToast(`Fichaje de ${type} exitoso`);
                document.getElementById('log-note').value = '';
                fetchTodayLogs(); // Recargar lista
            } catch (e) {
                alert("Error al guardar: " + e.message);
            } finally {
                btnIn.disabled = false; btnOut.disabled = false;
                btnIn.classList.remove('opacity-50'); btnOut.classList.remove('opacity-50');
            }
        }

        async function fetchTodayLogs() {
            const container = document.getElementById('today-list');
            if(SHEETDB_URL === 'PEGAR_TU_URL_AQUI') {
                container.innerHTML = '<div class="p-4 text-center text-red-400 text-xs">Falta configurar API URL</div>';
                return;
            }

            try {
                // Traemos datos. SheetDB free no filtra muy bien fechas complejas server-side,
                // así que traemos los últimos 50 y filtramos en JS.
                const res = await fetch(`${SHEETDB_URL}?limit=50`);
                const allData = await res.json();
                
                const todayStr = new Date().toLocaleDateString('es-ES');
                
                // Filtrar solo los de hoy
                const todayData = allData.filter(row => row.fecha === todayStr).reverse();

                if(todayData.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-slate-500 italic">No hay actividad hoy</div>';
                    return;
                }

                let html = '';
                todayData.forEach(row => {
                    const color = row.tipo === 'ENTRADA' ? 'text-emerald-400' : 'text-rose-400';
                    html += `
                        <div class="p-3 flex justify-between items-center hover:bg-slate-800 transition">
                            <div>
                                <div class="font-bold text-white text-sm">${row.empleado}</div>
                                <div class="text-xs text-slate-500">${row.hora} <span class="mx-1">•</span> <span class="${color} font-bold">${row.tipo}</span></div>
                            </div>
                            ${row.nota ? `<i class="fa-regular fa-comment-dots text-slate-500" title="${row.nota}"></i>` : ''}
                        </div>
                    `;
                });
                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = '<div class="p-4 text-center text-red-400">Error de conexión</div>';
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('-translate-y-20', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
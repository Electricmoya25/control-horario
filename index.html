<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal del Empleado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .digital-clock { font-variant-numeric: tabular-nums; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col items-center justify-center">

    <!-- ========================================== -->
    <!-- CONFIGURACIÓN: PEGA TU URL DE SHEETDB AQUÍ -->
    <!-- ========================================== -->
    <script>
        const SHEETDB_URL = 'https://sheetdb.io/api/v1/hwvpn8lhbw0gg'; 
    </script>
    <!-- ========================================== -->

    <!-- VISTA LOGIN -->
    <div id="login-view" class="w-full max-w-md p-6 fade-in">
        <div class="bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 p-8">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/50">
                    <i class="fa-solid fa-user-lock text-3xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">Identificación</h2>
                <p class="text-slate-400 text-sm mt-1">Selecciona tu usuario para fichar</p>
            </div>

            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Empleado</label>
                    <select id="login-user" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 text-white outline-none">
                        <option value="">Cargando empleados...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Contraseña</label>
                    <input type="password" id="login-pass" placeholder="••••••" class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 text-white outline-none">
                </div>

                <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition shadow-lg btn-press">
                    Acceder <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
        <div class="text-center mt-8">
            <div id="clock-login" class="text-4xl font-bold text-slate-700 digital-clock">00:00:00</div>
        </div>
    </div>

    <!-- VISTA FICHAJE (Oculta por defecto) -->
    <div id="dashboard-view" class="w-full max-w-md p-6 hidden fade-in">
        
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="font-bold text-xl text-white" id="user-display">Hola, Usuario</h1>
                <p class="text-xs text-green-400 font-mono">Sesión Activa</p>
            </div>
            <button onclick="logout()" class="text-xs bg-slate-800 hover:bg-red-900/30 hover:text-red-400 px-3 py-2 rounded-lg border border-slate-700 transition">
                <i class="fa-solid fa-power-off mr-1"></i> Salir
            </button>
        </header>

        <!-- Estado Actual -->
        <div class="bg-slate-800 rounded-2xl p-6 shadow-xl border border-slate-700 mb-6 text-center">
            <p class="text-slate-400 text-xs uppercase tracking-widest mb-2">Hora Actual</p>
            <div id="clock-dash" class="text-5xl font-bold text-white digital-clock mb-6">00:00:00</div>

            <!-- Botones Dinámicos -->
            <div id="action-container">
                <div class="animate-pulse text-slate-500">Comprobando estado...</div>
            </div>
        </div>

        <!-- Historial Hoy -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
            <div class="p-3 bg-slate-900/50 border-b border-slate-700">
                <h3 class="font-bold text-sm text-slate-300">Tu actividad de hoy</h3>
            </div>
            <div id="today-logs" class="p-4 text-sm text-slate-400">
                Cargando...
            </div>
        </div>
    </div>

    <script>
        // --- RELOJ ---
        function updateClocks() {
            const now = new Date().toLocaleTimeString('es-ES');
            document.getElementById('clock-login').innerText = now;
            document.getElementById('clock-dash').innerText = now;
        }
        setInterval(updateClocks, 1000);

        // --- GLOBAL VARS ---
        let usersList = [];
        let currentUser = null;
        let todayRecord = null; // Guarda el registro del día si existe

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', async () => {
            if(SHEETDB_URL === 'PEGAR_TU_URL_AQUI') {
                Swal.fire('Error', 'Configura la URL de SheetDB en el código', 'error');
                return;
            }
            await loadEmployees();
        });

        // 1. CARGAR EMPLEADOS PARA EL SELECT
        async function loadEmployees() {
            const select = document.getElementById('login-user');
            try {
                // Importante: ?sheet=empleados
                const res = await fetch(`${SHEETDB_URL}?sheet=empleados`);
                usersList = await res.json();
                
                select.innerHTML = '<option value="">Selecciona tu nombre...</option>';
                usersList.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.nombre; // Usamos el nombre como ID para simplificar visualización
                    opt.innerText = u.nombre;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option>Error al cargar</option>';
            }
        }

        // 2. LOGIN
        async function login() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;

            if(!user || !pass) return Swal.fire('Atención', 'Completa todos los campos', 'warning');

            const validUser = usersList.find(u => u.nombre === user && u.password == pass);

            if (validUser) {
                currentUser = validUser;
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('user-display').innerText = `Hola, ${user.split(' ')[0]}`;
                document.getElementById('login-pass').value = ''; // Limpiar pass
                
                await checkStatus();
            } else {
                Swal.fire('Error', 'Contraseña incorrecta', 'error');
            }
        }

        function logout() {
            location.reload();
        }

        // 3. COMPROBAR ESTADO (¿Ya fichó entrada hoy?)
        async function checkStatus() {
            const container = document.getElementById('action-container');
            const logContainer = document.getElementById('today-logs');
            const todayStr = new Date().toLocaleDateString('es-ES');

            try {
                // Buscamos en la hoja 'asistencia' registros de este usuario y fecha hoy
                // Nota: SheetDB search API es limitada, traemos todo lo del usuario y filtramos en cliente para asegurar
                const res = await fetch(`${SHEETDB_URL}/search?sheet=asistencia&empleado=${currentUser.nombre}`);
                const data = await res.json();
                
                // Buscar registro de HOY
                todayRecord = data.find(r => r.fecha === todayStr);

                // Renderizar Historial Mini
                if(todayRecord) {
                    const entrada = todayRecord.hora_entrada || '--:--';
                    const salida = todayRecord.hora_salida || '--:--';
                    const total = todayRecord.horas_totales || 'Calculando...';
                    
                    logContainer.innerHTML = `
                        <div class="flex justify-between mb-2"><span>Entrada:</span> <span class="text-white font-mono">${entrada}</span></div>
                        <div class="flex justify-between mb-2"><span>Salida:</span> <span class="text-white font-mono">${salida}</span></div>
                        <div class="flex justify-between pt-2 border-t border-slate-700"><span>Horas:</span> <span class="text-emerald-400 font-bold">${total}</span></div>
                    `;
                } else {
                    logContainer.innerHTML = 'Aún no has fichado hoy.';
                }

                // Renderizar Botones (Lógica Principal)
                if (!todayRecord) {
                    // No hay registro hoy -> Mostrar botón ENTRADA
                    container.innerHTML = `
                        <button onclick="registrarEntrada()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white p-6 rounded-xl shadow-lg transition flex flex-col items-center gap-2 active:scale-95 group">
                            <i class="fa-solid fa-right-to-bracket text-3xl group-hover:scale-110 transition"></i>
                            <span class="font-bold text-xl">REGISTRAR ENTRADA</span>
                        </button>
                    `;
                } else if (todayRecord.hora_salida === '' || !todayRecord.hora_salida) {
                    // Hay registro pero sin salida -> Mostrar botón SALIDA
                    container.innerHTML = `
                        <button onclick="registrarSalida('${todayRecord.id}')" class="w-full bg-rose-600 hover:bg-rose-500 text-white p-6 rounded-xl shadow-lg transition flex flex-col items-center gap-2 active:scale-95 group">
                            <i class="fa-solid fa-right-from-bracket text-3xl group-hover:scale-110 transition"></i>
                            <span class="font-bold text-xl">REGISTRAR SALIDA</span>
                        </button>
                    `;
                } else {
                    // Ya tiene entrada y salida -> Jornada Completa
                    container.innerHTML = `
                        <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 text-slate-400">
                            <i class="fa-solid fa-check-circle text-green-500 text-2xl mb-2"></i><br>
                            Jornada de hoy completada.
                        </div>
                    `;
                }

            } catch (e) {
                console.error(e);
                container.innerText = "Error de conexión con la base de datos.";
            }
        }

        // 4. REGISTRAR ENTRADA
        async function registrarEntrada() {
            Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading() });
            
            const now = new Date();
            const uniqueId = crypto.randomUUID(); // Generamos ID único para poder editar luego
            
            const newRow = {
                id: uniqueId,
                fecha: now.toLocaleDateString('es-ES'),
                empleado: currentUser.nombre,
                hora_entrada: now.toLocaleTimeString('es-ES'),
                hora_salida: "",
                horas_totales: "",
                estado: "INCOMPLETO",
                nota: ""
            };

            try {
                await fetch(`${SHEETDB_URL}?sheet=asistencia`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [newRow] })
                });

                await Swal.fire({
                    icon: 'success',
                    title: '¡Entrada Registrada!',
                    text: 'Que tengas un buen día.',
                    timer: 2000,
                    showConfirmButton: false
                });
                logout(); // Auto-logout

            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            }
        }

        // 5. REGISTRAR SALIDA
        async function registrarSalida(recordId) {
            Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading() });

            const now = new Date();
            const horaSalida = now.toLocaleTimeString('es-ES');
            
            // Calcular horas trabajadas
            // Asumimos formato HH:MM:SS
            const entradaParts = todayRecord.hora_entrada.split(':');
            const entradaDate = new Date();
            entradaDate.setHours(entradaParts[0], entradaParts[1], entradaParts[2]);

            const diffMs = now - entradaDate; // diferencia en milisegundos
            const diffHrs = Math.floor((diffMs % 86400000) / 3600000); // horas
            const diffMins = Math.round(((diffMs % 86400000) % 3600000) / 60000); // minutos
            const totalTexto = `${diffHrs}h ${diffMins}m`;

            const updateData = {
                hora_salida: horaSalida,
                horas_totales: totalTexto,
                estado: "COMPLETO"
            };

            try {
                // PATCH usando la columna ID para identificar la fila
                // Endpoint: /api/v1/{api_id}/id/{value}?sheet=asistencia
                await fetch(`${SHEETDB_URL}/id/${recordId}?sheet=asistencia`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: updateData })
                });

                await Swal.fire({
                    icon: 'success',
                    title: '¡Salida Registrada!',
                    text: `Has trabajado: ${totalTexto}`,
                    timer: 3000,
                    showConfirmButton: false
                });
                logout();

            } catch (e) {
                Swal.fire('Error', 'No se pudo registrar la salida. Intenta de nuevo.', 'error');
            }
        }
    </script>
</body>
</html>